<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi칩n | SmartParking</title>
    <!-- Mantenemos tus referencias a archivos CSS -->
    <link rel="stylesheet" href="/www/css/general.css">
    <link rel="stylesheet" href="/www/css/login.css">
    <!-- Si usas registro.css, puedes mantenerlo si afecta estilos globales -->
</head>
<body>
    <div class="container">
        <div class="sub-container">
            
            <img src="/www/img/logotipo-SmartParking.jpg" alt="SmartParking Logo" class="logo">
            
            <h1>Iniciar Sesi칩n</h1>

            <!-- 1. A침adimos un ID al formulario para capturarlo en JavaScript -->
            <!-- 2. Quitamos action="/login" ya que lo manejaremos con JavaScript -->
            <form id="loginForm" action="#" method="post">
                <!-- 3. Cambiamos el ID a 'correo' para que coincida con el backend -->
                <label for="correo">Correo Electr칩nico:</label>
                <input type="text" id="correo" name="correo" required placeholder="tu.correo@ejemplo.com">

                <!-- 4. Cambiamos el ID a 'contrase침a' para que coincida con el backend -->
                <label for="contrase침a">Contrase침a:</label>
                <input type="password" id="contrase침a" name="contrase침a" required placeholder="Ingresa tu contrase침a">

                <a href="recuperar_contrasena.html" class="enlace-olvido">쯆lvidaste tu contrase침a?</a>

                <!-- 5. Movemos el bot칩n dentro del formulario para que sea el trigger de submit -->
                <button type="submit">ENTRAR</button>
            </form>

            <a href="registro.html" class="resgistro">쯅o tienes cuenta? Reg칤strate</a>

            <!-- 츼rea de mensajes para feedback del servidor -->
            <div id="mensaje" style="margin-top: 20px; padding: 10px; text-align: center; border-radius: 5px; font-size: 0.9rem; display: none;"></div>
        </div>
        
    </div>
    
    <!-- 游댷 SCRIPT para enviar datos al backend -->
    <script>
        // 游뚿 URL del endpoint de Login
        const API_URL_LOGIN = "http://localhost:3000/api/usuarios/login";
        const form = document.getElementById("loginForm");
        const mensajeDiv = document.getElementById("mensaje");

        // Funci칩n auxiliar para mostrar mensajes (copiada de registro.html para consistencia)
        function mostrarMensaje(texto, esError = true) {
            mensajeDiv.textContent = texto;
            mensajeDiv.style.backgroundColor = esError ? '#f8d7da' : '#d4edda';
            mensajeDiv.style.color = esError ? '#721c24' : '#155724';
            mensajeDiv.style.display = 'block';
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault(); // Evita el env칤o tradicional del formulario

            // 1. Recolecci칩n de datos: usamos los IDs 'correo' y 'contrase침a'
            const datos = {
                correo: document.getElementById("correo").value,
                contrase침a: document.getElementById("contrase침a").value 
            };
            
            // Limpiamos el mensaje anterior
            mensajeDiv.style.display = 'none';

            try {
                // 2. Petici칩n POST al backend
                const res = await fetch(API_URL_LOGIN, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(datos)
                });

                // 3. Procesamiento de la respuesta
                const resultado = await res.json();
                
                if (res.ok) {
                    // 칄xito (Status 200)
                    mostrarMensaje(`춰Bienvenido ${resultado.usuario.nombre}! Inicio de sesi칩n exitoso.`, false);
                    // Opcional: Guardar token o redirigir a la p치gina principal
                    // window.location.href = 'dashboard.html';
                } else {
                    // Error de autenticaci칩n (401) o de servidor (500)
                    // El backend devuelve: 'Credenciales inv치lidas (correo o contrase침a).'
                    mostrarMensaje(`Error al iniciar sesi칩n: ${resultado.error || 'Credenciales inv치lidas.'}`, true);
                }

            } catch (error) {
                // Error de red (servidor apagado o URL incorrecta)
                console.error("Error de red/conexi칩n:", error);
                mostrarMensaje("Error de conexi칩n: Aseg칰rate de que tu servidor Node.js est칠 funcionando.", true);
            }
        });
    </script>
</body>
</html>
